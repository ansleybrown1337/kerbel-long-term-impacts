---
title: "Bayesian Modeling of STIR Effects on Water Quality"
author: "AJ Brown"
output:
  html_document:
    toc: true
    toc_depth: 3
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE
)

# Load backend cleaning + functions
getwd()
source("./stir-bayes-backend.R")
library(rethinking)
library(dplyr)
library(ggplot2)
```

# Model 1.0 - STIR total effect on OUT concentration with analyte-specific slopes and intercepts

# 1. Load and clean STIRâ€“WQ dataset

```{r load-clean}
# Step 1: load raw merged dataset
wq_raw <- load_wq_stir(
  path = "out/wq_with_stir_by_season.csv",
  year_max = Inf
)

# Step 2: clean, type-enforce, standardize (ALL done in backend)
wq_clean <- clean_wq_stir(wq_raw)

glimpse(wq_clean)
```

---

# 2. Prepare model-ready dataset

You now choose which variables enter your model from the fields already standardized in the backend:

* `cout_z` = per-analyte standardized OUT concentrations
* `cin_z`  = per-analyte standardized INFLOW concentrations
* `stir_season_z` = standardized seasonal STIR
* `stir_cumall_z` = standardized cumulative STIR
* `analyte_abbr` = clean factor index

Select analytes for modeling:

```{r subset-analytes}
# analytes: OP   TP   ICP  NO3  TN   TSS  TKN  TSP  NH4  NPOC Se   NO2  NOx  TDS
analytes_keep <- c("TP", "TSS")   # modify as needed
# fullset for ease of use
analytes_keep <- c("OP", "TP", "ICP", "NO3", "TN", "TSS", 
                   "TKN", "TSP", "NH4", "NPOC", "Se", "NO2", 
                   "NOx", "TDS")

d_mod <- wq_clean %>%
  filter(analyte_abbr %in% analytes_keep)

d_mod %>% count(analyte_abbr)
```

Create analyte index and build data list for ulam:

```{r make-stan-dat}
d_mod <- d_mod %>% 
  mutate(
    A = as.integer(analyte_abbr)
  )

stan_dat <- list(
  N    = nrow(d_mod),
  J    = length(unique(d_mod$A)),
  A    = as.factor(d_mod$A),
  C    = d_mod$cout_z,          # standardized concentration
  STIR = d_mod$stir_season_z    # standardized STIR predictor
)

str(stan_dat)
```

---

# 3. Hierarchical Bayesian model

```{r fit-model, eval=T}
m_stir <- ulam(
  alist(
    C ~ dnorm(mu, sigma),
    mu <- alpha[A] + beta[A] * STIR,

    alpha[A] ~ dnorm(a_bar, sigma_alpha),
    beta[A]  ~ dnorm(b_bar, sigma_beta),

    c(a_bar, b_bar) ~ dnorm(0, 1),
    sigma_alpha ~ dexp(1),
    sigma_beta  ~ dexp(1),
    sigma       ~ dexp(1)
  ),
  data = stan_dat,
  chains = 4,
  cores = 4,
  iter = 2000
)
```

---

# 4. Posterior inspection

```{r summarize, eval=FALSE}
precis(m_stir, depth=2, prob=0.95)
plot(precis(m_stir, depth=2, prob=0.95))
```

```{r extract, eval=FALSE}
post <- extract.samples(m_stir)

alpha_hat <- apply(post$alpha, 2, mean)
beta_hat  <- apply(post$beta,  2, mean)

# 89 percent HPDI and 95 percent PI, McElreath-style
beta_hpdi <- apply(post$beta, 2, HPDI, prob = 0.89)
beta_pi   <- apply(post$beta, 2, PI,   prob = 0.95)

analyte_lookup <- d_mod %>% 
  distinct(A, analyte_abbr) %>%
  arrange(A)

analyte_effects <- analyte_lookup %>%
  mutate(
    beta_mean = beta_hat,
    beta_median = apply(post$beta, 2, median),
    beta_hpdi_low  = beta_hpdi[1, ],
    beta_hpdi_high = beta_hpdi[2, ],
    beta_pi_low    = beta_pi[1, ],
    beta_pi_high   = beta_pi[2, ]
  )
analyte_effects
```

---

# 5. Plot posterior slopes

```{r plot-slopes, eval=FALSE}
# Recreate an index for plotting
A_seq <- analyte_effects$A
beta_mean  <- analyte_effects$beta_mean
beta_hpdi  <- analyte_effects %>% select(beta_hpdi_low, beta_hpdi_high)
beta_pi    <- analyte_effects %>% select(beta_pi_low, beta_pi_high)

# Base R plot setup
plot(
  A_seq, beta_mean,
  xaxt = "n",
  pch = 16,
  col = "darkred",
  ylim = range(c(beta_pi$beta_pi_low, beta_pi$beta_pi_high)),
  ylab = "Effect of STIR on Concentration",
  xlab = "Analyte",
  main = "Analyte-specific STIR effects with 89% HPDI and 95% PI"
)

axis(1, at = A_seq, labels = analyte_effects$analyte_abbr, las = 2)

# 95 percent PI vertical lines
for (i in seq_along(A_seq)) {
  lines(
    x = c(A_seq[i], A_seq[i]),
    y = c(beta_pi$beta_pi_low[i], beta_pi$beta_pi_high[i]),
    col = col.alpha("darkred", 0.2),
    lwd = 5
  )
}

# 89 percent HPDI vertical lines (darker)
for (i in seq_along(A_seq)) {
  lines(
    x = c(A_seq[i], A_seq[i]),
    y = c(beta_hpdi$beta_hpdi_low[i], beta_hpdi$beta_hpdi_high[i]),
    col = col.alpha("darkred", 0.4),
    lwd = 5
  )
}

# Add zero reference line
abline(h = 0, lty = 2)

```

---

# 6. Next steps

* Add censoring models for nondetects
* Compare seasonal STIR vs cumulative STIR
* Include treatment-level or year-level random effects
* Fit analyte-specific models for sensitivity analysis

